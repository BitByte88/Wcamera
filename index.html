<!DOCTYPE html>

<html lang="ja">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">

<title>TORESYS 3D for trittschaum</title>

<meta name="title" content="TORESYS 3D for trittschaum">
<meta name="description" content="">
<meta name="keywords" content="">
<meta property="og:title" content="">
<meta property="og:url" content="">
<meta property="og:image" content="">
<meta property="og:site_name" content="">
<meta property="og:description" content="">

<link href="./common/css/drawer.css" rel="stylesheet" type="text/css" media="all">
<link href="./common/css/layout.css" rel="stylesheet" type="text/css" media="all">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
<link href="./common/css/iziModal.css" rel="stylesheet" type="text/css" media="all">

<style>
main {
  padding: 0;
}
#V-NEW-1 {
  padding: 0 15px 20px;
}
#V-NEW-1 .registForm li:nth-child(3),
#V-NEW-1 .registForm li:nth-child(4),
#V-NEW-2,
#V-NEW-2 .bottomBt .photoNum,
#V-NEW-3,
#V-NEW-4,
#V-NEW-1 .assistCheckWrapper {
  display: none;
}
#V-NEW-2 .bottomBt a, #V-NEW-2 .bottomBt span {
  font-size: calc(100vw / 16);
}
</style>

<style>
#V-NEW-2 .results ul li {
}
#V-NEW-2 .results ul li img {
}
#V-NEW-2 .results ul li p {
    background-color: yellow;
    margin-top: -20px;
}
</style>
</head>

<body class="drawer drawer--right">

<div class="wrapper">
<!--
<header class="drawer-navbar drawer-navbar--fixed" role="banner">
    <div class="drawer-container">
        <div class="drawer-navbar-header">
            <p class="drawer-logo"><img src="./common/img/logo_toresys3d_w.png" alt=""></p>
            <p class="drawer-brand"><span class="orgName"></span><br><span class="usrName"></span></p>
            <button type="button" class="drawer-toggle drawer-hamburger">
                <span class="sr-only">toggle navigation</span>
                <span class="drawer-hamburger-icon"></span>
            </button>
        </div>
    </div>
</header>
-->
<main role="main">
    <section id="V-NEW-1">
        <h2>新規作成</h2>
        <p class="pageVisual"><img src="./common/img/img_camera.png" alt=""></p>
        <ul class="error">
        </ul>
        <ul class="registForm">
            <li style="display: none!important;"><input type="text" placeholder="タイトル" name="name"><p class="notice">タイトルを省略すると撮影日時で自動作成されます。</p></li>
            <li>
                <p class="notice narrow left assistCheckWrapper"><label for="assistCheck"><input type="checkbox" id="assistCheck" checked="checked" name="assistCheck">アシストあり</label></p>
                <a href="#" class="btTakePhoto" data-transition-id="V-NEW-2">撮影する</a>
            </li>
            <li><a href="#" class="btViewPhoto" data-transition-id="V-NEW-3">撮影した写真を見る</a></li>
            <li style="display: none!important;"><a href="#" class="btRegistPhoto" id="registPhoto">3Dデータに変換する</a></li>
            <li style="display: none!important;"><a href="main.html" class="btBackPhoto">キャンセル</a></li>
        </ul><!--/.registForm-->
    </section>
    <section id="V-NEW-2">
        <video id="video" autoplay="autoplay" playsinline="playsinline"></video>
        <div class="control"><div id="takePhoto"><!--撮影ボタン--></div></div>
        <canvas id="canvas"></canvas>
        <div class="assistWrapper"><span></span></div>
        <div class="results">
            <ul>
            </ul>
        </div>
        <ul class="bottomBt">
            <li><span class="photoNum">99枚</span></li>
            <li><a href="#" class="btFinish" data-transition-id="V-NEW-1">撮影終了</a></li>
        </ul>
    </section>

    <section id="V-NEW-3" class="thumbnailList">
        <ul class="thumbnails">
        </ul>
        <div class="btBox">
            <p><a href="#" class="btBack" data-transition-id="V-NEW-1">戻る</a></p>
        </div>
    </section>

    <section id="V-NEW-4">
        <p class="thumbnailDetail"></p>
        <ul class="bottomBt">
            <li><a href="#" class="btBack" data-transition-id="V-NEW-3">戻る</a></li>
            <li><a href="#" class="btRemove">削除</a></li>
        </ul>
    </section>
</main>

</div><!--/.wrapper-->

<div id="loadingModal">
    <div>
        <i class="fa fa-spinner fa-spin fa-5x fa-fw"></i>
        <p>&nbsp;</p>
    </div>
</div>

<div class="iziModal" data-izimodal-title="撮影ガイド">
    <p>ここにコンテンツ</p>
</div>

<script src="./common/js/jquery-3.3.1.min.js"></script>
<script src="./common/js/iscroll.js"></script>
<script src="./common/js/drawer.js"></script>
<script src="./common/js/ofi.min.js"></script>
<script src="./common/js/iziModal.min.js"></script>

<script src="./common/js/jquery-ui.min.js"></script>
<script src="./common/js/app.js"></script>

<script>
<!--
var app = new App();
var isAssistEnabled;
var authKey = localStorage.authKey;

// ヘッダー情報取得
localStorage.organization = "テスト企業";
localStorage.userName = "テストユーザ";
if (!localStorage.organization || !localStorage.userName) {
    location.href = "login.html";
}
var organization = localStorage.organization;
var userName = localStorage.userName;
if (userName.length >10) {
    userName = userName.substring(0, 10) + '...';
}
if (organization.length >16) {
    organization = organization.substring(0, 16) + '...';
}
$(".orgName").html(organization);
$(".usrName").html((userName) + '様');
-->
//$('.drawer').drawer();
objectFitImages( '.thumbnailList img' );

$(".iziModal").iziModal();

$('#assistCheck').change(function() {
    localStorage.assistCheck = $('#assistCheck').prop('checked');
});
if (localStorage.assistCheck && localStorage.assistCheck == "false") {
    $('#assistCheck').prop('checked', false);
} else {
    localStorage.assistCheck = "true";
}
$('#assistCheck').closest('.assistCheckWrapper').show();
<!--
$('#logout').click(function() {
    // ログアウトAPI
    app.logout(authKey).then(function(res) {
        localStorage.removeItem('userName');
        localStorage.removeItem('organization');
        localStorage.removeItem('targetJobId');
        sessionStorage.clear();
        location.href = "login.html";
    }).catch(function() {
        alert("予期しないエラーが発生しました。\nログインからやり直してください。");
        localStorage.removeItem('userName');
        localStorage.removeItem('organization');
        localStorage.removeItem('targetJobId');
        localStorage.removeItem('autoLogin');
        sessionStorage.clear();
        location.href = "login.html";
        return false;
    }).then(function() {
        app.hideLoading();
        return false;
    });
});
-->
$(document).on('click', '[data-transition-id]', function() {
    var dest = $(this).data('transition-id');
    if (dest == 'V-NEW-2') {
      if (!video.srcObject) {
        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia(medias)
            .then(function(stream) {
              video.srcObject = stream;
              video.onloadedmetadata = function() {
                var ratio = $(window).width() / video.videoWidth;
                video.width = $(window).width();
                video.height = video.videoHeight * ratio;
                canvas.width = video.width;
                canvas.height = video.height;
                $('#takePhoto').show();
              };
              $('#V-NEW-1').closest('section').hide();
              $('#' + dest).show("slide", { direction: "right"}, 200);
            }).catch(function(err) {
              alert(err);
              resetMetaViewport();
              $('#V-NEW-2').closest('section').hide();
              $('#V-NEW-1').show();
              return false;
            });
          requestAnimationFrame(draw);
        } else {
          alert("navigator.mediaDevices not supported");
          $('#V-NEW-1').closest('section').hide();
          $('#' + dest).show("slide", { direction: "right"}, 200);
          //return false;
        }
      } else {
        $('#V-NEW-1').closest('section').hide();
        $('#' + dest).show("slide", { direction: "right"}, 200);
      }
      $('#V-NEW-2 .photoNum').text($('#V-NEW-2 .results img').length + '枚').css('display', 'block');
      updateMetaViewport();
      isAssistEnabled = !isPhotoRegistered() && $('#assistCheck').prop('checked');
      if (isAssistEnabled) {
          showAssist(0);
      } else {
          hideAssist();
      }
    } else {
      resetMetaViewport();
      if (dest == 'V-NEW-3') {
        $('#V-NEW-3 ul.thumbnails').empty();
        $('#V-NEW-2 .results img').each(function() {
          var $img = $('<img></img>').attr('src', $(this).attr('src')).attr('data-img-id', $(this).attr('data-img-id'));
          $('#V-NEW-3 ul.thumbnails').append($('<li></li>').append($img));
        });
      } else if (dest == 'V-NEW-1') {
        if (isPhotoRegistered()) {
          $('.assistCheckWrapper').hide();
        } else {
          $('.assistCheckWrapper').show();
        }
      }
      $(this).closest('section').hide();
      $('#' + $(this).data('transition-id')).show("slide", { direction: "right"}, 200);
    }
    return false;
});

$('#registPhoto').click(function() {
    var err = [];
    $('ul.error').empty();
    $('ul.error').hide();
    var datasetName = $('input[name="name"]').val();
    if (datasetName.length > 50) {
        err.push("データセット名は50文字以内で設定してください。");
    }
    if ($('#V-NEW-2 .results img').length > 20) {
        err.push("画像は20枚以内で設定してください。");
    }
    if (err.length > 0) {
      for (var i in err) {
          $('ul.error').append($('<li></li>').text(err[i]));
      }
      $('ul.error').show();
      return false;
    }

    app.showLoading('画像を登録中');
    // データセット新規作成
    app.createDataset(authKey, datasetName).then(function(res) {
        var datasetId = res.datasetid;
        var imgNameIdx = 1;
        var promises = [];
        $('#V-NEW-2 .results img').each(function() {
            // 画像取得
            var b64 = $(this).attr('src');
            // データセット更新API(action=append)
            promises.push(app.appendImageToDataset(datasetId, b64, authKey));
        });
        Promise.all(promises).then(function(res) {
            app.showLoading('3Dデータ変換処理を開始中');
            var engineType = '';
            // ジョブ新規作成　datasetId, name, engineType, execution, authKey
            app.createJob(datasetId, datasetName, engineType, "false", authKey).then(function(res) {
                // ジョブ更新(type=command, command=execute)
                app.executeJob(res.jobid, authKey).then(function() {
                    location.href = "main.html";
                }).catch(function() {
                    alert("予期しないエラーが発生しました。\nログインからやり直してください。");
                    app.hideLoading();
                    localStorage.removeItem('userName');
                    localStorage.removeItem('organization');
                    localStorage.removeItem('targetJobId');
                    localStorage.removeItem('autoLogin');
                    sessionStorage.clear();
                    location.href = "login.html";
                    return false;
                });
            }).catch(function() {
                alert("予期しないエラーが発生しました。\nログインからやり直してください。");
                app.hideLoading();
                localStorage.removeItem('userName');
                localStorage.removeItem('organization');
                localStorage.removeItem('targetJobId');
                localStorage.removeItem('autoLogin');
                sessionStorage.clear();
                location.href = "login.html";
                return false;
            }).then(function() {
                app.hideLoading();
            });
        }).catch(function() {
            alert("予期しないエラーが発生しました。");
            app.hideLoading();
        });
    }).catch(function() {
        alert("予期しないエラーが発生しました。\nログインからやり直してください。");
        app.hideLoading();
        localStorage.removeItem('userName');
        localStorage.removeItem('organization');
        localStorage.removeItem('targetJobId');
        localStorage.removeItem('autoLogin');
        sessionStorage.clear();
        location.href = "login.html";
    });
});

const medias = {audio : false, video : {facingMode : {exact: "environment"}}},
      video  = document.getElementById("video"),
      canvas = document.getElementById("canvas"),
      ctx    = canvas.getContext("2d");

function draw() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    requestAnimationFrame(draw);
}

var imgIdIdx = 0;
$('#takePhoto').click(function() {
    var dataURL = canvas.toDataURL('image/jpeg');
    var img = document.createElement('img');
    var blob = base64ToFile(dataURL);
    $(img).on('load', function() {
        var $result = $('<li></li>');
        $('#V-NEW-2 .results ul').prepend($result.append($("<p>w/h:" + img.width + "/" + img.height + "," + getByteString(blob.size) + "</p>")).append($(img).attr('data-img-id', imgIdIdx++)));
        $('#V-NEW-2 .photoNum').text($('#V-NEW-2 .results img').length + '枚').css('display', 'block');
        //$('#V-NEW-1 .btViewPhoto, #V-NEW-1 .btRegistPhoto').closest('li').css('display', 'block');
        $('#V-NEW-1 .btViewPhoto').closest('li').css('display', 'block');
        if (isAssistEnabled) {
            showAssist($('#V-NEW-2 .results ul li').length);
        }
    });
    img.setAttribute('src', dataURL);
});

$(document).on('click', '#V-NEW-3 .thumbnails img', function() {
    $('#V-NEW-4 .thumbnailDetail').empty();
    var img = document.createElement('img');
    var imgId = $(this).attr('data-img-id');
    $(img).on('load', function() {
        $('#V-NEW-4 .thumbnailDetail').append($(img).attr('data-img-id', imgId));
        $('#V-NEW-3').closest('section').hide();
        $('#V-NEW-4').show("slide", { direction: "right"}, 200);
    });
    img.setAttribute('src', $(this).attr('src'));
});

$('#V-NEW-4 .btRemove').click(function() {
    if (confirm('この画像を削除します。よろしいですか？')) {
        var imgId = $('#V-NEW-4 .thumbnailDetail img').attr('data-img-id');
        $('#V-NEW-2 img[data-img-id=' + imgId + ']').closest('li').remove();
        $('#V-NEW-3 img[data-img-id=' + imgId + ']').closest('li').remove();
        if ($('#V-NEW-3 ul.thumbnails li').length == 0) {
            $('#V-NEW-1 .btViewPhoto, #V-NEW-1 .btRegistPhoto').closest('li').css('display', 'none');
            $('.btBack[data-transition-id="V-NEW-3"]').attr('data-transition-id', 'V-NEW-1');
            $('.btBack[data-transition-id="V-NEW-1"]').click();
            $('.btBack[data-transition-id="V-NEW-1"]').attr('data-transition-id', 'V-NEW-3');
        } else {
            $('.btBack[data-transition-id="V-NEW-3"]').click();
        }
    }
});
function updateMetaViewport() {
    $('header').hide();
    var ua = navigator.userAgent.toLowerCase();
    var isiOS = (ua.indexOf("iphone") > -1) || (ua.indexOf("ipod") > -1) || (ua.indexOf("ipad") > -1);
    var width = 3000;
    if (isiOS) {
        $("meta[name='viewport']").attr("content", "width=" + width + "px,user-scalable=no,shrink-to-fit=yes");
        $('main').css({'margin-top': '-500px'});
        $('.assistWrapper').css({'margin-top': '500px'});
    } else {
        var scale = $(window).width() / width;
        $("meta[name='viewport']").attr("content", "initial-scale=" + scale + ",minimum-scale=" + scale + ",user-scalable=no,shrink-to-fit=yes");
        $('main').css({'margin-top': '-200px'});
        $('.assistWrapper').css({'margin-top': '200px'});
    }
}
function resetMetaViewport() {
    $('main').css({'margin-top': '0'});
    $('header').show();
    $("meta[name='viewport']").attr("content", "width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no");
}
function isPhotoRegistered() {
    return $('#V-NEW-2 .results ul li').length > 0;
}
function showAssist(i) {
    if (i < 11) {
        $('#V-NEW-2 .assistWrapper span').text((i + 1) + '/11');
        $('#V-NEW-2 .assistWrapper').attr('data-index', i).show();
    } else {
        hideAssist();
    }
}
function hideAssist() {
    $('#V-NEW-2 .assistWrapper').removeAttr('data-index');
    $('#V-NEW-2 .assistWrapper').hide();
}

function base64ToFile(data) {
  try{
    let separetedDate = data.split(',');
    let mimeTypeData = separetedDate[0].match(/:(.*?);/);
    let mimeType = Array.isArray(mimeTypeData) ? mimeTypeData[0] : '';
    let decodedData = atob(separetedDate[1]);
    let dataLength = decodedData.length;
    let arrayBuffer = new ArrayBuffer(dataLength);
    let u8arr = new Uint8Array(arrayBuffer);

    for( let i = 0; i < dataLength; i +=1){
      u8arr[i] = decodedData.charCodeAt(i);
    }

    return new Blob([u8arr] , {type:mimeType});

  }catch (errors){
    console.log(errors);
    return new Blob([])
  }
}

function getByteString (size) {
  var target = getTarget(size);
  var d = Math.pow(10, 2);
  var newSize = target !== null ? Math.floor((size / target.target) * d) / d : size;
  return newSize + target.unit;
}
function getTarget (size) {
  var kb = 1024
  var mb = Math.pow(kb, 2)
  var gb = Math.pow(kb, 3)
  var tb = Math.pow(kb, 4)

  if (size >= tb) return { target: tb, unit: 'TB' }
  if (size >= gb) return { target: gb, unit: 'GB' }
  if (size >= mb) return { target: mb, unit: 'MB' }
  if (size >= kb) return { target: kb, unit: 'KB' }

  return { target: null, unit: 'byte' }
}
</script>

</body>
</html>
